name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Pochi.app
        run: ./build.sh

      - name: Create ZIP archive
        run: |
          ditto -c -k --sequesterRsrc --keepParent Pochi.app Pochi.zip

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            Pochi.zip \
            --title "Pochi ${{ github.ref_name }}" \
            --notes "$(cat <<'NOTES'
          ## Install

          1. Download **Pochi.zip** and unzip
          2. Move **Pochi.app** to `/Applications`
          3. Open Terminal and run:

          ```
          xattr -cr /Applications/Pochi.app
          ```

          4. Open Pochi.app — grant microphone permission when prompted

          > The `xattr -cr` command removes the macOS quarantine flag.
          > This is required because the app is ad-hoc signed (no Apple Developer ID).

          ## Shortcuts

          | Key | Action |
          |-----|--------|
          | ⌘⌥R | Start / Stop recording |
          | ⌘⌥P | Open / Close panel |

          ## MCP Setup (Claude Code)

          ```
          eval $(/Applications/Pochi.app/Contents/MacOS/Pochi --mcp-install)
          ```

          ## MCP Setup (Claude Desktop)

          Add to your Claude Desktop config:
          ```
          /Applications/Pochi.app/Contents/MacOS/Pochi --mcp-config
          ```

          ---
          NOTES
          )"
