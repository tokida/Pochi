name: Auto Tag and Release on Merge

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  tag:
    # PRがマージされた場合のみ実行（クローズのみは除外）
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate date-based tag
        id: tag
        run: |
          # 日付ベースのタグを生成（UTC）
          DATE=$(date -u +%Y.%m.%d)
          BASE_TAG="v${DATE}"

          # 同日に既存タグがあれば連番を付与
          EXISTING=$(git tag -l "${BASE_TAG}*" | sort -V)
          if [ -z "$EXISTING" ]; then
            TAG="${BASE_TAG}"
          else
            # 既存タグの最大連番を取得
            LAST=$(echo "$EXISTING" | tail -1)
            if [ "$LAST" = "$BASE_TAG" ]; then
              TAG="${BASE_TAG}.1"
            else
              # v2026.02.07.N -> N を取得してインクリメント
              NUM=$(echo "$LAST" | grep -oE '\.[0-9]+$' | tr -d '.')
              NEXT=$((NUM + 1))
              TAG="${BASE_TAG}.${NEXT}"
            fi
          fi

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Generated tag: ${TAG}"

      - name: Create and push tag
        run: |
          git tag "${{ steps.tag.outputs.tag }}" "${{ github.event.pull_request.merge_commit_sha }}"
          git push origin "${{ steps.tag.outputs.tag }}"

      - name: Summary
        run: |
          echo "## Tag Created" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Tag:** \`${{ steps.tag.outputs.tag }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **PR:** #${{ github.event.pull_request.number }} ${{ github.event.pull_request.title }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Commit:** \`${{ github.event.pull_request.merge_commit_sha }}\`" >> "$GITHUB_STEP_SUMMARY"

  release:
    # GITHUB_TOKENで作成したタグはon:push:tagsを発火しないため、
    # タグ作成後に同一ワークフロー内でビルド＆リリースを実行する
    needs: tag
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.tag.outputs.tag }}

      - name: Build Pochi.app
        run: ./build.sh

      - name: Create ZIP archive
        run: |
          ditto -c -k --sequesterRsrc --keepParent Pochi.app Pochi.zip

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ needs.tag.outputs.tag }} \
            Pochi.zip \
            --title "Pochi ${{ needs.tag.outputs.tag }}" \
            --notes "$(cat <<'NOTES'
          ## Install

          1. Download **Pochi.zip** and unzip
          2. Move **Pochi.app** to `/Applications`
          3. Open Terminal and run:

          ```
          xattr -cr /Applications/Pochi.app
          ```

          4. Open Pochi.app — grant microphone permission when prompted

          > The `xattr -cr` command removes the macOS quarantine flag.
          > This is required because the app is ad-hoc signed (no Apple Developer ID).

          ## Shortcuts

          | Key | Action |
          |-----|--------|
          | ⌘⌥R | Start / Stop recording |
          | ⌘⌥P | Open / Close panel |

          ## MCP Setup (Claude Code)

          ```
          eval $(/Applications/Pochi.app/Contents/MacOS/Pochi --mcp-install)
          ```

          ## MCP Setup (Claude Desktop)

          Add to your Claude Desktop config:
          ```
          /Applications/Pochi.app/Contents/MacOS/Pochi --mcp-config
          ```

          ---
          NOTES
          )"
